<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Drop Report</title>
    
    <!-- PWA and Mobile App Manifest -->
    <meta name="theme-color" content="#1d4ed8">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1d4ed8/ffffff?text=CDR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashDrop">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhc2ggRHJvcCBSZXBvcnQiLAogICJzaG9ydF9uYW1lIjogIkNhc2hEcm9wIiwKICAiaWQiOiAiLz9zb3VyY2U9cHdhIiwKICAiZGVzY3JpcHRpb24iOiAiQSBzaW1wbGUgYXBwIGZvciByZXBvcnRpbmcgZGFpbHkgY2FzaCBkcm9wcy4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsCiAgInRoZW1lX2NvbG9yIjogIiMxZDRlZDgiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzFkNGVkOC9mZmZmZmY/dGV4dD1DRFIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi8xZDRlZDgvZmZmZmZmP3RleHQ9Q0RSIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence, browserLocalPersistence,
            getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, getDoc, Timestamp, setDoc, updateDoc, query, orderBy, where
        };
    </script>
    
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            background-color: #0f172a; /* bg-slate-900 */
            font-family: 'Inter', sans-serif;
            color: #e2e8f0; /* text-slate-200 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

        /******************************************************************************
         * CONFIGURATION
         *****************************************************************************/
        const firebaseConfig = {
            apiKey: "AIzaSyA4upjtl0UFToWSfRZEiEQvwz9ieFLfqhI",
            authDomain: "cashflow-mgr.firebaseapp.com",
            projectId: "cashflow-mgr",
            storageBucket: "cashflow-mgr.appspot.com",
            messagingSenderId: "873891130920",
            appId: "1:873891130920:web:b6b8f0432943c33a930f1d",
            measurementId: "G-LVLMJ8ZY0B"
        };
        const DEFAULT_EXCHANGE_RATE = 4000;

        /******************************************************************************
         * CONTEXT & CUSTOM HOOKS
         *****************************************************************************/
        const AuthContext = createContext();
        const AppContext = createContext();

        const useAuth = () => useContext(AuthContext);
        const useAppContext = () => useContext(AppContext);

        /******************************************************************************
         * PROVIDERS
         *****************************************************************************/
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const app = window.firebase.initializeApp(firebaseConfig);
                const firebaseAuth = window.firebase.getAuth(app);
                const firestoreDb = window.firebase.getFirestore(app);
                setAuth(firebaseAuth);
                setDb(firestoreDb);

                const unsubscribe = window.firebase.onAuthStateChanged(firebaseAuth, async (firebaseUser) => {
                    if (firebaseUser) {
                        const userDocRef = window.firebase.doc(firestoreDb, 'employees', firebaseUser.uid);
                        const userDoc = await window.firebase.getDoc(userDocRef);
                        if (userDoc.exists()) {
                            setUser(firebaseUser);
                            setUserData({ uid: firebaseUser.uid, ...userDoc.data() });
                        } else {
                            await window.firebase.signOut(firebaseAuth);
                            setAuthError({ message: `Your employee profile was not found. Please contact an administrator.` });
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const login = useCallback(async (email, password, rememberMe) => {
                const persistence = rememberMe 
                    ? window.firebase.browserLocalPersistence 
                    : window.firebase.browserSessionPersistence;
                await window.firebase.setPersistence(auth, persistence);
                return window.firebase.signInWithEmailAndPassword(auth, email, password);
            }, [auth]);

            const logout = useCallback(() => window.firebase.signOut(auth), [auth]);

            const value = { user, userData, login, logout, db, loading, authError, setAuthError };
            return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
        };

        const AppProvider = ({ children }) => {
            const { db } = useAuth();
            const [shops, setShops] = useState([]);
            const [reports, setReports] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!db) return;
                
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                const reportsQuery = window.firebase.query(
                    window.firebase.collection(db, "cashDrops"), 
                    window.firebase.orderBy("createdAt", "desc"),
                    window.firebase.where("createdAt", ">=", startOfMonth)
                );
                
                const unsubReports = window.firebase.onSnapshot(reportsQuery, 
                    (snapshot) => setReports(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                    (err) => console.error("Error fetching reports:", err)
                );
                
                const unsubShops = window.firebase.onSnapshot(window.firebase.collection(db, "shops"), (snapshot) => {
                    setShops(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => {
                    console.error("Error fetching shops:", err);
                    setIsLoading(false);
                });

                return () => {
                    unsubReports();
                    unsubShops();
                };
            }, [db]);

            const value = { shops, reports, isLoading, appSettings: { exchangeRate: DEFAULT_EXCHANGE_RATE } };
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };
        
        /******************************************************************************
         * UTILITY FUNCTIONS
         *****************************************************************************/
        const formatCurrency = (value, currency) => {
            const number = parseFloat(String(value).replace(/,/g, '')) || 0;
            const formatted = number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return currency === 'KHR' ? `${formatted} ៛` : (currency === 'USD' ? `${formatted} $` : formatted);
        };
        
        const formatDateDDMMYY = (date) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2);
            return `${day}-${month}-${year}`;
        };

        /******************************************************************************
         * SHARED UI COMPONENTS
         *****************************************************************************/
        const Icon = React.memo(({ name, className = "w-5 h-5" }) => {
            const icons = {
                loader: <svg className={`${className} animate-spin`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                note: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>,
                trash: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                logout: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l-3 3m3-3V9" /></svg>,
                eye: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                'eye-off': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>,
                install: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>,
                export: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>,
                'document-text': <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
            };
            return icons[name] || null;
        });

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-screen">
                <Icon name="loader" className="w-12 h-12 text-blue-500" />
            </div>
        );

        const Modal = ({ children, onClose, isOpen }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className="bg-slate-800 border border-slate-700 rounded-lg shadow-xl w-full max-w-md flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        };
        
        const FormInput = React.memo(({ label, name, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1">{label}</label>
                <input id={name} name={name} {...props} className="block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-100 disabled:bg-slate-800 disabled:text-slate-400" />
            </div>
        ));

        const FormSelect = React.memo(({ label, name, options, ...props }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-slate-300 mb-1">{label}</label>
                <select id={name} name={name} {...props} className="block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-100">
                    {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                </select>
            </div>
        ));
        
        const CurrencyInputGroup = React.memo(({ title, khrName, usdName, khrValue, usdValue, onChange }) => (
            <div>
                <h3 className="text-md font-semibold text-slate-400">{title}</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                    <FormInput label="KHR (៛)" name={khrName} value={khrValue} onChange={onChange} placeholder="0.00" />
                    <FormInput label="USD ($)" name={usdName} value={usdValue} onChange={onChange} placeholder="0.00" />
                </div>
            </div>
        ));
        
        /******************************************************************************
         * MODAL COMPONENTS
         *****************************************************************************/
        const SubmitConfirmationModal = ({ onConfirm, onClose, isSubmitting }) => (
            <Modal isOpen={true} onClose={onClose}>
                <div className="p-6"><h3 className="text-lg font-bold text-slate-100">បញ្ជាក់ការបញ្ជូនរបាយការណ៍</h3><p className="mt-2 text-sm text-slate-400">សូមពិនិត្យមើលព័ត៌មានលម្អិតមុនពេលបញ្ជូន ត្រឹមត្រូវហើយ?</p></div>
                <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-lg">
                    <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 disabled:opacity-50">បោះបង់</button>
                    <button onClick={onConfirm} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                        {isSubmitting && <Icon name="loader" className="w-4 h-4" />} បាទ​/ចាស៎
                    </button>
                </div>
            </Modal>
        );
        
        const DeleteConfirmationModal = ({ onConfirm, onClose, isSubmitting, isOpen }) => (
            <Modal isOpen={isOpen} onClose={onClose}>
                <div className="p-6"><h3 className="text-lg font-bold text-slate-100">Confirm Deletion</h3><p className="mt-2 text-sm text-slate-400">Are you sure you want to delete this report? This action cannot be undone.</p></div>
                <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-lg">
                    <button onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 disabled:opacity-50">Cancel</button>
                    <button onClick={onConfirm} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50 flex items-center gap-2">
                        {isSubmitting && <Icon name="loader" className="w-4 h-4" />} Delete
                    </button>
                </div>
            </Modal>
        );
        
        const CustomDateRangeModal = ({ isOpen, onClose, onApply }) => {
            const [dates, setDates] = useState({ startDate: '', endDate: '' });
            const handleApply = () => { onApply(dates); onClose(); };
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="p-6"><h3 className="text-lg font-bold text-slate-100">Select Custom Date Range</h3>
                        <div className="mt-4 space-y-4">
                            <FormInput label="Start Date" type="date" value={dates.startDate} onChange={e => setDates(d => ({...d, startDate: e.target.value}))} />
                            <FormInput label="End Date" type="date" value={dates.endDate} onChange={e => setDates(d => ({...d, endDate: e.target.value}))} />
                        </div>
                    </div>
                    <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 rounded-b-lg">
                        <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600">Cancel</button>
                        <button onClick={handleApply} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Apply</button>
                    </div>
                </Modal>
            );
        };

        const EditReportModal = ({ isOpen, onClose, onSave, report, isSubmitting, shops }) => {
            const [formData, setFormData] = useState({});
            const formRef = useRef(null);
            
            useEffect(() => {
                if (report) {
                    setFormData({ ...report,
                        date: report.createdAt?.toDate().toISOString().split('T')[0] || '',
                        cashUsd: String(report.cashUsd || ''), cashKhr: String(report.cashKhr || ''),
                        bankUsd: String(report.bankUsd || ''), bankKhr: String(report.bankKhr || ''),
                        note: report.note || '',
                    });
                }
            }, [report]);

            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                const formatCurrencyValue = (val) => val.replace(/[^0-9.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                if (['cashUsd', 'cashKhr', 'bankUsd', 'bankKhr'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatCurrencyValue(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            const handleSave = (e) => { e.preventDefault(); onSave(formData); };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="p-6 border-b border-slate-700"><h3 className="text-lg font-bold text-slate-100">Edit Report</h3></div>
                    <form ref={formRef} onSubmit={handleSave} className="flex-grow overflow-y-auto p-6 space-y-4">
                        <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                        <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={shops.map(s => ({value: s.name, label: s.name}))} required />
                        <FormInput label="Staff" name="staff" value={formData.staff} disabled />
                        <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                        <CurrencyInputGroup title="By Cash" khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleFormChange} />
                        <CurrencyInputGroup title="By Bank" khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleFormChange} />
                        <FormInput label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="Add an optional note..."/>
                    </form>
                    <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 border-t border-slate-700 sticky bottom-0 rounded-b-lg">
                        <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600">Cancel</button>
                        <button type="submit" form="edit-report-form" onClick={() => formRef.current.requestSubmit()} disabled={isSubmitting} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2">
                            {isSubmitting && <Icon name="loader" className="w-4 h-4" />} Save Changes
                        </button>
                    </div>
                </Modal>
            );
        };

        const NoteViewModal = ({ isOpen, onClose, note }) => (
            <Modal isOpen={isOpen} onClose={onClose}>
                <div className="p-6 border-b border-slate-700"><h3 className="text-lg font-bold text-slate-100">Report Note</h3></div>
                <div className="p-6 flex-grow overflow-y-auto"><p className="text-slate-300 whitespace-pre-wrap">{note}</p></div>
                <div className="bg-slate-900/50 px-6 py-3 flex justify-end items-center gap-3 border-t border-slate-700 rounded-b-lg">
                    <button type="button" onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600">Close</button>
                </div>
            </Modal>
        );

        /******************************************************************************
         * LOGIN PAGE
         *****************************************************************************/
        const LoginPage = () => {
            const { login, authError, setAuthError } = useAuth();
            const [credentials, setCredentials] = useState({ email: '', password: '' });
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(true);

            useEffect(() => {
                if (authError) {
                    setError(authError);
                    setAuthError(null); // Clear error after displaying
                }
            }, [authError, setAuthError]);
            
            const handleChange = (e) => setCredentials(prev => ({...prev, [e.target.name]: e.target.value}));

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    await login(credentials.email, credentials.password, rememberMe);
                } catch (err) {
                    setError({ message: 'Failed to log in. Please check your email and password.' });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-md">
                        <div className="bg-slate-800/50 p-8 md:p-10 rounded-2xl shadow-lg border border-slate-700">
                            <div className="text-center mb-8"><h1 className="text-3xl font-bold text-slate-100">JLW Cash Drop</h1><p className="mt-2 text-sm text-slate-400">Internal Use Only. Please log in.</p></div>
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div className="relative"><input id="email" name="email" type="email" value={credentials.email} onChange={handleChange} required placeholder="Email address" className="block w-full pl-4 pr-3 py-2.5 bg-slate-700 border border-slate-600 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-100"/></div>
                                <div className="relative">
                                    <input id="password" name="password" type={showPassword ? 'text' : 'password'} value={credentials.password} onChange={handleChange} required placeholder="Password" className="block w-full pl-4 pr-10 py-2.5 bg-slate-700 border border-slate-600 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-100"/>
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-200">{showPassword ? <Icon name="eye-off" /> : <Icon name="eye" />}</button>
                                </div>
                                <div className="flex items-center"><input id="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)} className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-600 rounded bg-slate-700"/><label htmlFor="remember-me" className="ml-2 block text-sm text-slate-300">Remember me</label></div>
                                {error && <p className="text-red-500 text-sm text-center">{error.message}</p>}
                                <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50 transition-all shadow-lg hover:shadow-blue-500/50">
                                    {loading ? <Icon name="loader" /> : 'Log In'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        /******************************************************************************
         * CASH DROP FORM & COMPONENTS
         *****************************************************************************/
        const NewCashDropForm = () => {
            const { shops, appSettings } = useAppContext();
            const { db, userData } = useAuth();
            
            const getInitialState = useCallback(() => ({
                date: new Date().toISOString().split('T')[0],
                shop: (userData?.role === 'Admin' || userData?.role === 'Management') ? (shops[0]?.name || '') : (shops.find(s => userData?.shopIds?.includes(s.id))?.name || ''),
                staff: userData?.name || '', shift: 'Morning',
                cashUsd: '', cashKhr: '', bankUsd: '', bankKhr: '', note: '',
            }), [shops, userData]);

            const [formData, setFormData] = useState(getInitialState);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);

            useEffect(() => { setFormData(getInitialState()) }, [getInitialState]);
            
            const handleFormChange = useCallback((e) => {
                const { name, value } = e.target;
                const formatCurrencyValue = (val) => val.replace(/[^0-9.]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                if (['cashUsd', 'cashKhr', 'bankUsd', 'bankKhr'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatCurrencyValue(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            }, []);

            const grandTotal = useMemo(() => {
                const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                return (clean(formData.cashUsd) + clean(formData.bankUsd)) * appSettings.exchangeRate + clean(formData.cashKhr) + clean(formData.bankKhr);
            }, [formData, appSettings.exchangeRate]);

            const handleConfirmSubmit = useCallback(async () => {
                setIsSubmitting(true);
                try {
                    const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                    await window.firebase.addDoc(window.firebase.collection(db, "cashDrops"), {
                        ...formData,
                        cashUsd: clean(formData.cashUsd), cashKhr: clean(formData.cashKhr),
                        bankUsd: clean(formData.bankUsd), bankKhr: clean(formData.bankKhr),
                        grandTotalKhr: grandTotal,
                        createdAt: window.firebase.Timestamp.fromDate(new Date()),
                        submittedBy: userData.uid
                    });
                    setFormData(getInitialState());
                } catch (error) { console.error("Error submitting report:", error); } 
                finally { setIsSubmitting(false); setIsConfirming(false); }
            }, [formData, grandTotal, userData, db, getInitialState]);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                return (userData.role === 'Admin' || userData.role === 'Management') 
                    ? shops 
                    : shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            return (
                <>
                    <form onSubmit={(e) => { e.preventDefault(); setIsConfirming(true); }} className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <div className="lg:col-span-2 bg-slate-800/50 border border-slate-700 p-6 rounded-lg shadow-lg">
                            <h2 className="text-xl font-semibold text-slate-100 border-b border-slate-700 pb-4 mb-6">New Cash Drop Form</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormInput label="Date" type="date" name="date" value={formData.date} onChange={handleFormChange} required />
                                <FormSelect label="Shop" name="shop" value={formData.shop} onChange={handleFormChange} options={availableShops.map(s => ({value: s.name, label: s.name}))} required />
                                <FormInput label="Staff" name="staff" value={formData.staff} disabled />
                                <FormSelect label="Shift" name="shift" value={formData.shift} onChange={handleFormChange} options={[{value:'Morning', label:'Morning'}, {value:'Afternoon', label:'Afternoon'}, {value:'Night', label:'Night'}]} />
                            </div>
                            <div className="space-y-4 pt-6 mt-6 border-t border-slate-700">
                                <CurrencyInputGroup title="By Cash" khrName="cashKhr" usdName="cashUsd" khrValue={formData.cashKhr} usdValue={formData.cashUsd} onChange={handleFormChange} />
                                <CurrencyInputGroup title="By Bank" khrName="bankKhr" usdName="bankUsd" khrValue={formData.bankKhr} usdValue={formData.bankUsd} onChange={handleFormChange} />
                            </div>
                            <div className="pt-6 mt-6 border-t border-slate-700"><FormInput label="Note" name="note" value={formData.note} onChange={handleFormChange} placeholder="Add an optional note..."/></div>
                        </div>
                        <SummaryCard formData={formData} grandTotal={grandTotal} isSubmitting={isSubmitting} />
                    </form>
                    {isConfirming && <SubmitConfirmationModal onClose={() => setIsConfirming(false)} onConfirm={handleConfirmSubmit} isSubmitting={isSubmitting} />}
                </>
            );
        };
        
        const SummaryCard = React.memo(({ formData, grandTotal, isSubmitting }) => (
             <div className="lg:col-span-1 bg-slate-800/50 border border-slate-700 p-6 rounded-lg shadow-lg space-y-4 lg:sticky top-24">
                <h3 className="text-xl font-semibold text-slate-100 border-b border-slate-700 pb-4">Summary</h3>
                <div className="space-y-3 text-md pt-2">
                    <div className="flex justify-between items-center"><span className="text-slate-400">Cash KHR :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.cashKhr, 'KHR')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-400">Cash USD :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.cashUsd, 'USD')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-400">Bank KHR :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.bankKhr, 'KHR')}</span></div>
                    <div className="flex justify-between items-center"><span className="text-slate-400">Bank USD :</span><span className="font-mono font-semibold text-slate-200">{formatCurrency(formData.bankUsd, 'USD')}</span></div>
                </div>
                <div className="border-t border-slate-700 !my-4"></div>
                <div className="flex justify-between items-center"><span className="font-bold text-slate-100 text-lg">Grand Total :</span><span className="font-extrabold text-red-500 text-2xl">{formatCurrency(grandTotal, 'KHR')}</span></div>
                <button type="submit" disabled={isSubmitting} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center !mt-6 disabled:opacity-50 transition-all shadow-lg hover:shadow-blue-500/50">
                    {isSubmitting ? <Icon name="loader" /> : 'Submit Report'}
                </button>
            </div>
        ));
        
        /******************************************************************************
         * REPORTS DASHBOARD & COMPONENTS
         *****************************************************************************/
        const ReportsDashboard = () => {
            const { reports, shops, appSettings } = useAppContext();
            const { db, userData } = useAuth();
            const [filters, setFilters] = useState({ shop: '', dueTime: 'Daily', startDate: '', endDate: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [modalState, setModalState] = useState({ edit: null, delete: null, note: null, customDate: false });

            const handleModalOpen = useCallback((type, data) => setModalState(prev => ({ ...prev, [type]: data })), []);
            const handleModalClose = useCallback((type) => setModalState(prev => ({ ...prev, [type]: null })), []);

            const availableShops = useMemo(() => {
                if (!userData) return [];
                return (userData.role === 'Admin' || userData.role === 'Management') 
                    ? shops 
                    : shops.filter(s => userData.shopIds?.includes(s.id));
            }, [shops, userData]);

            const shopColorMap = useMemo(() => {
                const colors = ['blue', 'green', 'yellow', 'pink', 'indigo', 'teal'];
                return shops.reduce((map, shop, index) => {
                    const color = colors[index % colors.length];
                    map[shop.name] = { base: `bg-${color}-900/20`, hover: `hover:bg-${color}-800/30` };
                    return map;
                }, {});
            }, [shops]);
            
            const handleConfirmDelete = useCallback(async () => {
                if (!modalState.delete) return;
                setIsSubmitting(true);
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(db, "cashDrops", modalState.delete.id));
                    handleModalClose('delete');
                } catch (error) { console.error("Error deleting report:", error); } 
                finally { setIsSubmitting(false); }
            }, [modalState.delete, db, handleModalClose]);

            const handleSaveEdit = useCallback(async (editedData) => {
                if (!modalState.edit) return;
                setIsSubmitting(true);
                try {
                    const clean = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;
                    const grandTotal = (clean(editedData.cashUsd) + clean(editedData.bankUsd)) * appSettings.exchangeRate + clean(editedData.cashKhr) + clean(editedData.bankKhr);
                    const reportRef = window.firebase.doc(db, "cashDrops", modalState.edit.id);
                    await window.firebase.updateDoc(reportRef, {
                        ...editedData,
                        createdAt: window.firebase.Timestamp.fromDate(new Date(editedData.date)),
                        cashUsd: clean(editedData.cashUsd), cashKhr: clean(editedData.cashKhr),
                        bankUsd: clean(editedData.bankUsd), bankKhr: clean(editedData.bankKhr),
                        grandTotalKhr: grandTotal,
                    });
                    handleModalClose('edit');
                } catch (error) { console.error("Error updating report:", error); } 
                finally { setIsSubmitting(false); }
            }, [modalState.edit, db, appSettings.exchangeRate, handleModalClose]);

            const filteredAndAggregatedData = useMemo(() => {
                if (!reports || !userData) return null;
                
                const userFilteredReports = (userData.role !== 'Admin' && userData.role !== 'Management')
                    ? reports.filter(report => availableShops.map(s => s.name).includes(report.shop))
                    : reports;
                
                let filtered = userFilteredReports;
                const { dueTime, startDate, endDate, shop } = filters;

                if (dueTime === 'Daily') {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    filtered = userFilteredReports.filter(r => r.createdAt?.toDate() >= yesterday);
                } else if (dueTime === 'Monthly') {
                    const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    filtered = userFilteredReports.filter(r => r.createdAt?.toDate() >= startOfMonth);
                } else if (dueTime === 'Yearly') {
                    const startOfYear = new Date(new Date().getFullYear(), 0, 1);
                    filtered = userFilteredReports.filter(r => r.createdAt?.toDate() >= startOfYear);
                } else if (dueTime === 'Custom' && startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    filtered = userFilteredReports.filter(r => r.createdAt?.toDate() >= start && r.createdAt?.toDate() <= end);
                }
                
                if (shop) filtered = filtered.filter(r => r.shop === shop);
                
                if (dueTime === 'Daily' || dueTime === 'Custom') return { type: 'detailed', data: filtered };
                
                const aggregated = filtered.reduce((acc, report) => {
                    const date = report.createdAt.toDate();
                    const period = (dueTime === 'Monthly') ? date.toLocaleString('default', { month: 'short', year: 'numeric' }) : date.getFullYear().toString();
                    const key = `${period}|${report.shop}`;
                    if (!acc[key]) acc[key] = { period, shop: report.shop, cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, grandTotalKhr: 0 };
                    acc[key].cashUsd += report.cashUsd || 0; acc[key].cashKhr += report.cashKhr || 0;
                    acc[key].bankUsd += report.bankUsd || 0; acc[key].bankKhr += report.bankKhr || 0;
                    acc[key].grandTotalKhr += report.grandTotalKhr || 0;
                    return acc;
                }, {});
                return { type: 'aggregated', data: Object.values(aggregated) };
            }, [reports, filters, userData, availableShops]);

            const totals = useMemo(() => {
                if (!filteredAndAggregatedData?.data) return { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, netSale: 0 };
                return filteredAndAggregatedData.data.reduce((acc, r) => { 
                    acc.cashUsd += r.cashUsd || 0; acc.cashKhr += r.cashKhr || 0; 
                    acc.bankUsd += r.bankUsd || 0; acc.bankKhr += r.bankKhr || 0; 
                    acc.netSale += r.grandTotalKhr || 0; 
                    return acc; 
                }, { cashUsd: 0, cashKhr: 0, bankUsd: 0, bankKhr: 0, netSale: 0 })
            }, [filteredAndAggregatedData]);
            
            const handleExport = useCallback(() => {
                if (!filteredAndAggregatedData?.data) return;
                const dataToExport = filteredAndAggregatedData.data.map(row => 
                    (filteredAndAggregatedData.type === 'detailed') ? {
                        'Date': formatDateDDMMYY(row.createdAt), 'Shop': row.shop, 'Staff': row.staff,
                        'Net Sale (KHR)': row.grandTotalKhr, 'Cash USD': row.cashUsd, 'Cash KHR': row.cashKhr,
                        'Bank USD': row.bankUsd, 'Bank KHR': row.bankKhr, 'Shift': row.shift
                    } : {
                        [filters.dueTime]: row.period, 'Shop': row.shop, 'Net Sale (KHR)': row.grandTotalKhr,
                        'Cash USD': row.cashUsd, 'Cash KHR': row.cashKhr, 'Bank USD': row.bankUsd, 'Bank KHR': row.bankKhr
                    }
                );
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cash Drop Report");
                XLSX.writeFile(workbook, `Cash_Drop_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            }, [filteredAndAggregatedData, filters.dueTime]);

            return (
                <div className="bg-slate-800/50 border border-slate-700 p-4 sm:p-6 rounded-lg shadow-lg mt-8">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 className="text-xl font-semibold text-slate-100">Daily Cash Drop History</h2>
                        <button onClick={handleExport} className="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm w-full sm:w-auto justify-center">
                            <Icon name="export" /> Export to Excel
                        </button>
                    </div>
                    
                    <ReportFilters filters={filters} setFilters={setFilters} shops={availableShops} onCustomClick={() => handleModalOpen('customDate', true)} />
                    
                    {!filteredAndAggregatedData ? <div className="py-16 flex justify-center items-center"><Icon name="loader" className="w-8 h-8 text-slate-400" /></div> :
                        (filteredAndAggregatedData.type === 'detailed') ? 
                            <ReportTable reports={filteredAndAggregatedData.data} totals={totals} onEdit={(r) => handleModalOpen('edit', r)} onDelete={(r) => handleModalOpen('delete', r)} onViewNote={(n) => handleModalOpen('note', n)} viewType={filters.dueTime} shopColorMap={shopColorMap} /> : 
                            <AggregatedReportTable reports={filteredAndAggregatedData.data} totals={totals} periodType={filters.dueTime} shopColorMap={shopColorMap} />
                    }
                    
                    <EditReportModal isOpen={!!modalState.edit} onClose={() => handleModalClose('edit')} onSave={handleSaveEdit} report={modalState.edit} isSubmitting={isSubmitting} shops={availableShops}/>
                    <DeleteConfirmationModal isOpen={!!modalState.delete} onClose={() => handleModalClose('delete')} onConfirm={handleConfirmDelete} isSubmitting={isSubmitting}/>
                    <CustomDateRangeModal isOpen={modalState.customDate} onClose={() => handleModalClose('customDate')} onApply={(dates) => setFilters(prev => ({...prev, ...dates}))}/>
                    <NoteViewModal isOpen={!!modalState.note} onClose={() => handleModalClose('note')} note={modalState.note}/>
                </div>
            );
        };
        
        const ReportFilters = React.memo(({ filters, setFilters, shops, onCustomClick }) => {
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                if (name === 'dueTime' && value === 'Custom') onCustomClick();
                setFilters(prev => ({...prev, [name]: value, startDate: '', endDate: ''}));
            };
            return (
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-slate-900/50 rounded-lg items-center">
                    <FormSelect label="Shop" name="shop" value={filters.shop} onChange={handleFilterChange} options={[{value:'',label:'All Shops'}, ...shops.map(s=>({value:s.name, label:s.name}))]} />
                    <FormSelect label="Due Time" name="dueTime" value={filters.dueTime} onChange={handleFilterChange} options={[{value:'Daily',label:'Daily'},{value:'Monthly',label:'Monthly'},{value:'Yearly',label:'Yearly'},{value:'Custom', label:'Custom'}]} />
                </div>
            );
        });
        
        const ReportTable = React.memo(({ reports, totals, onEdit, onDelete, onViewNote, viewType, shopColorMap }) => {
            const { userData } = useAuth();
            const canModify = userData?.role === 'Admin' || userData?.role === 'Management' || userData?.role === 'Shop Manager';
            return (
                <div className="overflow-x-auto">
                    {reports.length === 0 ? <div className="text-center py-16 text-slate-500"><p>No reports found for the selected filters.</p></div> :
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                                <tr>
                                    <th className="p-3">{viewType === 'Custom' ? 'Date' : 'Date & Time'}</th><th className="p-3">Shop</th>
                                    {viewType !== 'Custom' && <th className="p-3">Staff</th>}
                                    <th className="p-3 text-right">Net Sale (៛)</th><th className="p-3 text-right">Cash USD</th><th className="p-3 text-right">Cash KHR</th>
                                    <th className="p-3 text-right">Bank USD</th><th className="p-3 text-right">Bank KHR</th>
                                    {viewType !== 'Custom' && <th className="p-3 text-center">Actions</th>}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {reports.map(r => (
                                    <tr key={r.id} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-slate-700/50'}`}>
                                        <td className="p-3 whitespace-nowrap text-slate-400">{viewType === 'Custom' ? formatDateDDMMYY(r.createdAt) : r.createdAt?.toDate().toLocaleString('en-GB', { timeZone: 'Asia/Phnom_Penh' })}</td>
                                        <td className="p-3 text-slate-300">{r.shop}</td>
                                        {viewType !== 'Custom' && <td className="p-3 text-slate-300">{r.staff}</td>}
                                        <td className="p-3 text-right font-bold text-blue-400">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                        <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                        {viewType !== 'Custom' && <td className="p-3 flex gap-2 justify-center">
                                            {r.note && <button onClick={() => onViewNote(r.note)} className="p-1 text-yellow-400 hover:text-yellow-300"><Icon name="document-text"/></button>}
                                            <button onClick={() => canModify && onEdit(r)} disabled={!canModify} className="p-1 text-blue-400 hover:text-blue-300 disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="note"/></button>
                                            <button onClick={() => canModify && onDelete(r)} disabled={!canModify} className="p-1 text-red-500 hover:text-red-400 disabled:text-slate-600 disabled:cursor-not-allowed"><Icon name="trash"/></button>
                                        </td>}
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-slate-800 font-bold"><tr>
                                <td colSpan={viewType === 'Custom' ? 2 : 3} className="p-3 text-right text-slate-300">Sub-Total</td>
                                <td className="p-3 text-right font-mono text-blue-400">{formatCurrency(totals.netSale, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                                {viewType !== 'Custom' && <td />}
                            </tr></tfoot>
                        </table>
                    }
                </div>
            )
        });

        const AggregatedReportTable = React.memo(({ reports, totals, periodType, shopColorMap }) => (
            <div className="overflow-x-auto">
                {reports.length === 0 ? <div className="text-center py-16 text-slate-500"><p>No reports found for the selected filters.</p></div> :
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-900/50 text-xs text-slate-400 uppercase">
                            <tr>
                                <th className="p-3">{periodType}</th><th className="p-3">Shop</th><th className="p-3 text-right">Net Sale (៛)</th>
                                <th className="p-3 text-right">Cash USD</th><th className="p-3 text-right">Cash KHR</th>
                                <th className="p-3 text-right">Bank USD</th><th className="p-3 text-right">Bank KHR</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {reports.map(r => (
                                <tr key={`${r.period}-${r.shop}`} className={`${shopColorMap[r.shop]?.base || 'bg-transparent'} ${shopColorMap[r.shop]?.hover || 'hover:bg-slate-700/50'}`}>
                                    <td className="p-3 whitespace-nowrap text-slate-400">{r.period}</td>
                                    <td className="p-3 text-slate-300">{r.shop}</td>
                                    <td className="p-3 text-right font-bold text-blue-400">{formatCurrency(r.grandTotalKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.cashKhr, 'KHR')}</td>
                                    <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(r.bankKhr, 'KHR')}</td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot className="bg-slate-800 font-bold">
                            <tr>
                                <td colSpan={2} className="p-3 text-right text-slate-300">Sub-Total</td>
                                <td className="p-3 text-right font-mono text-blue-400">{formatCurrency(totals.netSale, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.cashKhr, 'KHR')}</td>
                                <td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankUsd, 'USD')}</td><td className="p-3 text-right font-mono text-slate-300">{formatCurrency(totals.bankKhr, 'KHR')}</td>
                            </tr>
                        </tfoot>
                    </table>
                }
            </div>
        ));
        
        /******************************************************************************
         * MAIN APP & ROOT COMPONENT
         *****************************************************************************/
        const AppHeader = () => {
            const { userData, logout } = useAuth();
            const [installPrompt, setInstallPrompt] = useState(null);

            useEffect(() => {
                const handler = e => { e.preventDefault(); setInstallPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = () => {
                if (!installPrompt) return;
                installPrompt.prompt();
                installPrompt.userChoice.then(() => setInstallPrompt(null));
            };

            return (
                <header className="bg-slate-800/50 border border-slate-700 p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div className="text-center sm:text-left">
                        <h1 className="text-2xl font-semibold text-slate-100">Cash Drop Report</h1>
                        <p className="mt-1 text-sm text-slate-400">Welcome, {userData.name} ({userData.role})</p>
                    </div>
                    <div className="flex items-center gap-2 w-full sm:w-auto">
                        {installPrompt && <button onClick={handleInstallClick} className="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="install" /> Install App</button>}
                        <button onClick={logout} className="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 text-sm grow justify-center"><Icon name="logout" /> Logout</button>
                    </div>
                </header>
            );
        };
        
        const CashDropPage = () => {
            const { userData } = useAuth();
            const { isLoading } = useAppContext();
            if (isLoading || !userData) return <LoadingSpinner />;
            return (
                <div className="space-y-8">
                    <NewCashDropForm />
                    {userData?.role !== 'Cashier' && userData?.role !== 'Staff' && <ReportsDashboard />}
                </div>
            );
        };
        
        const App = () => {
            const { user, loading } = useAuth();
            if (loading) return <LoadingSpinner />;
            if (!user) return <LoginPage />;
            return (
                <AppProvider>
                    <div className="container mx-auto p-4 md:p-8"><div className="max-w-7xl mx-auto"><AppHeader /><main><CashDropPage /></main></div></div>
                </AppProvider>
            );
        };

        const Root = () => (<AuthProvider><App /></AuthProvider>);

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>


